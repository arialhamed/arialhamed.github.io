{% assign chunked_loading_enabled = true %}{% if page.chunked_comment_loading == false %}{% assign chunked_loading_enabled = false %}{% else %}{% if site.google_forms_comments.chunked_comment_loading == false and page.chunked_comment_loading != true %}{% assign chunked_loading_enabled = false %}{% endif %}{% endif %}{% assign lazy_load_enabled = false %}{% if page.lazy_load_comments == true %}{% assign lazy_load_enabled = true %}{% elsif site.google_forms_comments.lazy_load_comments == true %}{% unless page.lazy_load_comments == false %}{% assign lazy_load_enabled = true %}{% endunless %}{% endif %}{% assign recaptcha_enabled = false %}{% if site.google_forms_comments.recaptcha_site_key %}{% assign recaptcha_enabled = true %}{% endif %}{% assign comment_replies_enabled = false %}{% if site.google_forms_comments.comment_replies_enabled == true %}{% assign comment_replies_enabled = true %}{% endif %}{% if site.comment-read or site.google_forms_comments.google_app_script %}
<script>
function setText(elementId, textContent) {gId(elementId).textContent = textContent};
function show(elementId) {gId(elementId).style.display = 'inline'};
function hide(elementId) {gId(elementId).style.display = 'none'};
function getValue(elementId) {return gId(elementId).value};
function setValue(elementId, value) {return gId(elementId).value = value};
function fadeIn(element) {var duration = 400; element.style.opacity = 0; let opacity = 0; const timer = setInterval(function() {opacity += 50 / duration; if (opacity >= 1) {clearInterval(timer); opacity = 1} element.style.opacity = opacity}, 50)};
function disableButtonWithLoader(elementId) {var buttonToDisable = gId(elementId);if (buttonToDisable == null) {return}buttonToDisable.disabled = true; setText(elementId, "\xa0")}
function disablePostCommentButton() {disableButtonWithLoader("comment-submit")};
function enablePostCommentButton() {var postCommentButton = gId("comment-submit"); postCommentButton.disabled = false; setText("comment-submit", "Post")};
async function initialCommentLoad() {
disableButtonWithLoader("load-comment-button");
{% unless site.google_forms_comments.google_app_script %}
var loadJquery = document.createElement("script");
loadJquery.type = "text/javascript";
loadJquery.src = "https://code.jquery.com/jquery-3.6.0.min.js";
document.head.appendChild(loadJquery);
{% endunless %}
var loadValidator = document.createElement("script");
loadValidator.src = "https://cdnjs.cloudflare.com/ajax/libs/validator/13.5.2/validator.min.js";
document.head.appendChild(loadValidator);
await loadValidator.onload; {% if site.google_forms_comments.google_app_script %}reloadComments(); {% else %}loadJquery.onload = function() {async function checkJQuery() {if (typeof jQuery === "undefined") {return false} else {clearTimeout(interval); var loadJqueryCsv = document.createElement("script"); loadJqueryCsv.src = "https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.11/jquery.csv.min.js"; document.head.appendChild(loadJqueryCsv); await loadJqueryCsv.onload; reloadComments()}}; var interval = setInterval(checkJQuery, 250)}; {% endif %}}; var thisPageUrl = "{{ page.url }}"; const EXTRA_INFO_START = "chunkedCommentInfoStart"; const EXTRA_INFO_END = "chunkedCommentInfoEnd"; var visibleComments = []; var hiddenComments = []; var netNewComments = []; var commentIds = new Set(); function formatDate(stringDate) {var date = new Date(stringDate);var dateOptions = { year: 'numeric', month: 'long', day: 'numeric'};var timeOptions = { hour: 'numeric', minute: 'numeric' };return `${date.toLocaleDateString("en-us", dateOptions)} at ${date.toLocaleTimeString("en-us", timeOptions)}`;}; async function displayComments(comments) {show("comments-and-input"); hide("load-comments"); var hasVisibleComments = visibleComments.length > 0; if (comments == null || comments === "" || comments == []) {if (!hasVisibleComments) {show("no-comments"); hide("load-more-comments"); hide("num-comments-displayed")} return} commentIds = new Set(); {% if site.google_forms_comments.google_app_script %}var newHiddenComments = comments.map(item=>{commentIds.add(Date.parse(item.timestamp)?.toString()); return item}).sort((a, b)=>(new Date(a.timestamp).getTime() || 0) - (new Date(b.timestamp).getTime() || 0)).map(item=>JSON.stringify(item)); {% else %}comments = `timestamp,name,comment,isAuthor\n${comments}`; var newHiddenComments = $.csv.toObjects(comments).map(item=>{commentIds.add(Date.parse(item.timestamp)?.toString());return item;}).sort((a, b)=>(new Date(a.timestamp).getTime() || 0) - (new Date(b.timestamp).getTime() || 0)).map(item=>JSON.stringify(item)); {% endif %}if (hasVisibleComments) {netNewComments = newHiddenComments.filter(item=>!visibleComments.includes(item)).filter(item=>!hiddenComments.includes(item))} hiddenComments = newHiddenComments.filter(item=>!visibleComments.includes(item)).filter(item=>!netNewComments.includes(item)); loadMoreComments(false || !hasVisibleComments)}; function loadMoreComments(isLoadMoreAction) {{% if chunked_loading_enabled  %}var newCommentsToDisplay = hiddenComments.slice(-5); {% else %}var newCommentsToDisplay = hiddenComments; {% endif %}if (isLoadMoreAction) {newCommentsToDisplay.reverse().forEach(element=>displaySingleComment(element, true)); hiddenComments = hiddenComments.filter(item=>!newCommentsToDisplay.includes(item) && !visibleComments.includes(item))} else {netNewComments.forEach(element=>displaySingleComment(element, false));netNewComments = []} setText("num-comments-displayed", `Showing ${visibleComments.length} of ${visibleComments.length + hiddenComments.length} comments`); if (hiddenComments.length == 0) {hide("load-more-comments")} else {show("load-more-comments")}}; var currentFadeItem = null; function fadeColor(element) {if (currentFadeItem != null) {clearInterval(currentFadeItem); currentFadeItem = null} var duration = 1000; var step = 25; let opacity = 1; const timer = setInterval(function() {opacity -= (1 / (duration / step)); if (opacity <= 0) {clearInterval(timer); currentFadeItem = null; opacity = 0; } element.style.background = "rgba(3, 155, 229, "+ opacity +")";}, step); currentFadeItem = timer}; function smoothScrollTo(element) {element.scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"})}; function jumpToComment(commentId) {var element = document.getElementsByClassName("" + commentId)[0]; while(element == null && hiddenComments.length > 0) {loadMoreComments(true); element = document.getElementsByClassName("" + commentId)[0]} if (element != null) {smoothScrollTo(element); fadeColor(element)}}; function clearCommentReplyItem() {gId("comment-reply-info").innerHTML = ``}; function replyToComment(commentId) {gId("comment-reply-info").innerHTML = `<small class="comment-reply-clear" onclick="clearCommentReplyItem()">‚ìç&nbsp;&nbsp;&nbsp;</small><small onClick="jumpToComment('${commentId}')">Replying to comment <a id="reply-to-comment-id">${commentId}</a></small>`; smoothScrollTo(document.getElementsByClassName("comments-form")[0])}; function getCommentInfo(comment) {var extraCommentInfo = comment?.match(EXTRA_INFO_START + ".+" + EXTRA_INFO_END); return {text : comment?.replace(extraCommentInfo, ""), extraCommentInfo : JSON.parse(extraCommentInfo?.toString()?.replace(EXTRA_INFO_START, "")?.replace(EXTRA_INFO_END, "") ?? "{}")}}; function displaySingleComment(element, isPrepend) {if (visibleComments.includes(element)) {return} var jsonElement = JSON.parse(element); var comment = getCommentInfo(jsonElement.comment); var verifiedAuthorTag = ""; if (jsonElement.isAuthor == true || jsonElement.isAuthor === "TRUE") {verifiedAuthorTag = "&nbsp;<strong>(Author)</strong>";} var newItem = document.createElement("div"); newItem.classList.add("comment-item"); newItem.classList.add("reply-item"); var commentReplyId = "" + Date.parse(jsonElement.timestamp); newItem.classList.add(commentReplyId); var replyToHtml = null; var replyId = comment?.extraCommentInfo?.replyToCommentId; if (replyId != null && replyId != "" && commentIds.has(replyId)) {replyToHtml = `<p class="comemnt-reply-id" onclick="jumpToComment('${replyId}')"><<< ${replyId}</p>`;} var currentCommentReplyButton = `<span class="comment-reply-button" title="Reply" onclick="replyToComment(${commentReplyId})"><svg style="margin: 1em -1.2em 0 0; height: 2.4em; " class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.5 8H11V6.1c0-.9-.9-1.4-1.5-.9L4.4 9.7a1.2 1.2 0 0 0 0 1.8l5 4.4c.7.6 1.6 0 1.6-.8v-2h2a3 3 0 0 1 3 3V19a5.6 5.6 0 0 0-1.5-11Z"/></svg></span>`; newItem.innerHTML = `<p class="commenter-name">${validator.escape(jsonElement.name.toString())}${verifiedAuthorTag}<small>${formatDate(jsonElement.timestamp)}{% if comment_replies_enabled %}${currentCommentReplyButton ?? ""}{% endif %}</small></p><div>{% if comment_replies_enabled %}${replyToHtml ?? ""}{% endif %}<p>${validator.escape(comment?.text?.toString()).replace(new RegExp('\r?\n','g'), '<br />')}</p></div>`.trim(); if (isPrepend) {gId("comment-container").prepend(newItem)} else {gId("comment-container").append(newItem)} fadeIn(newItem); visibleComments.push(element); hide("no-comments"); show("num-comments-displayed")}; {% if site.google_forms_comments.google_app_script %}function reloadComments() {fetch(`{{ site.google_forms_comments.google_app_script }}?url=${thisPageUrl}`).then(response=>response.json()).then(response=>{var error = response?.error || null; if (error != null) {console.error(error); setText("comment-submit-error", error); show("comment-submit-error"); } else {setText("comment-submit-error", ''); hide("comment-submit-error"); displayComments(response)}})}; {% else %}function reloadComments() {var sqlStatement = encodeURIComponent(`SELECT A, C, D, E WHERE B = '${thisPageUrl}'`); fetch(`{{ site.comment-read }}/gviz/tq?tqx=out:csv&sheet=comments&tq=${sqlStatement}&headers=0`).then(response=>response.text()).then(response=>displayComments(response))}; {% endif %}const encodeFormData = (data)=>{return Object.keys(data).map(key=>encodeURIComponent(key) + '=' + encodeURIComponent(data[key])).join('&')}; function getCommentContent() {var comment = getValue("comment-comment")?.toString(); var extraCommentInfo = {}; var replyToCommentId = document?.getElementById("reply-to-comment-id")?.text; if (replyToCommentId != null && replyToCommentId != "") {extraCommentInfo.replyToCommentId = replyToCommentId} if (Object.keys(extraCommentInfo).length !== 0) {comment = EXTRA_INFO_START + JSON.stringify(extraCommentInfo) + EXTRA_INFO_END + comment} return comment}{% if site.google_forms_comments.google_app_script %}function postComment(recaptchaToken) {disablePostCommentButton(); var username = getValue("comment-name"); var comment = getCommentContent(); fetch(`{{ site.google_forms_comments.google_app_script }}`, {method: 'POST', mode: 'cors', redirect: "follow", headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify({url : thisPageUrl?.toString(), name : username?.toString(), comment : comment?.toString(), recaptchaToken: (recaptchaToken || null)})}).then(response=>response.json()).then(response=>{var error = response?.error || null; if(error != null){console.error(error); setText("comment-submit-error", error); show("comment-submit-error")} else {setValue("comment-name", ''); setValue("comment-comment", ''); setText("comment-submit-error", ''); hide("comment-submit-error"); displayComments(response); clearCommentReplyItem()}}).catch(error=>{console.log(error)}).finally(()=>{enablePostCommentButton()}); return false}{% else %}function postComment(recaptchaToken) {disablePostCommentButton(); var username = getValue("comment-name"); var comment = getCommentContent(); fetch(`{{ site.comment-post }}/formResponse`, {method: 'POST', mode: 'no-cors', headers: {"Content-Type": "application/x-www-form-urlencoded"}, body: encodeFormData({"{{ site.comment-post-fields[0] }}" : thisPageUrl?.toString(), "{{ site.comment-post-fields[1] }}" : username?.toString(), "{{ site.comment-post-fields[2] }}" : comment?.toString()})}).then(response=>{setValue("comment-name", ''); setValue("comment-comment", ''); clearCommentReplyItem(); reloadComments()}).catch(error=>{console.log(error)}).finally(()=>{enablePostCommentButton()}); return false}{% endif %}</script><div id="load-comments" class="comments"><button id="load-comment-button" class="comment-button" onclick="initialCommentLoad()">load comments</button></div><div id="comments-and-input"><div id="comment-section" class="comments"><p id="num-comments-displayed"></p><button id="load-more-comments" class="comment-button" onclick="loadMoreComments(true)" type="button">load older comments</button><div id="no-comments" class="comment-info-text"><p>there are currently no comments on this article, be the first to add one below</p></div><div id="comment-container"></div></div><h4 class="post-subtitle">add a comment</h4><div class="comments"><div class="comment-info-text">{% if site.google_forms_comments.google_app_script %}<p id="comment-submit-error"></p>{% endif %}</div><div class="comments-form"><form onsubmit="return postComment()" id="comment-form" autocomplete="off"><ul><li><input id="comment-name" name="username" type="text" placeholder="Name" required="" value=""><p id="comment-reply-info"></p></li><li><textarea id="comment-comment" name="comment" placeholder="Comment" required=""></textarea></li><li><button id="comment-submit" type="submit" class="comment-button">post</button></li></ul></form></div></div></div><style>@import "https://fonts.googleapis.com/css?family=Arimo";#comment-form{background-color:transparent}.comment-item{position:relative;padding:.5em 2.5em;background-color:var(--overlay);width:95%;margin:1em auto;border-radius:8px}.comment-item:after{content:"";position:relative;display:block;clear:both}.comment-item p{line-height:1.6}.comment-item small{padding-left:.7em;color:#999;font-size:.8em}.commenter-name{color:#367588;text-decoration:none;font-size:1em;font-weight:700}.commenter-name strong{color:#e91e63;text-decoration:none;font-size:1em;font-weight:700}.post-subtitle{text-align:center}.comment-reply-button{float:right;cursor:pointer}.comment-reply-button:hover{color:#e91e63}.comemnt-reply-id{color:#e91e63;font-size:.9em;cursor:pointer}#comment-reply-info{float:right;font-size:.9em;color:#e91e63;cursor:pointer}#comment-reply-info small{vertical-align:middle}.comment-reply-clear{color:#e91e63;font-size:1.1em;cursor:pointer}#comment-reply-info p{margin:0}.comments-form{margin-left:1.7em;width:calc(100% - 3em)}.comments-form ul{list-style:none;margin-left:-40px}.comments-form ul li{margin-bottom:15px}.comments{align-items:center;border-top:0 dashed #fff6;padding-top:1rem;position:relative}.comment-button{border:0;border-radius:.25rem;background:transparent;color:var(--font-color);font-size:.9em;margin-bottom:20px;outline-style:none;padding:10px 20px;width:auto;min-width:25%;border:solid 1px var(--overlay-hover)}#comment-submit{width:100%;min-width:25%;position:relative;background-color:#36758888;color:#fff}.comment-button:disabled::after,.comment-button[disabled]::after{content:"";position:absolute;width:16px;height:16px;top:0;left:0;right:0;bottom:0;margin:auto;border:4px solid transparent;border-top-color:var(--font-color);border-radius:50%;-webkit-animation:button-loading-spinner 1s ease infinite;animation:button-loading-spinner 1s ease infinite}@keyframes button-loading-spinner{from{transform:rotate(0turn)}to{transform:rotate(1turn)}}@-webkit-keyframes button-loading-spinner{from{transform:rotate(0turn)}to{transform:rotate(1turn)}}#load-comment-button:hover{background-color:var(--overlay-hover)}#load-more-comments{width:auto}#load-more-comments,#num-comments-displayed{display:none}#comment-name,#comment-comment{width:100%;padding:10px;border:0;border-radius:8px;box-shadow:0 0 2px 2px #000;background-color:#ffffff15;color:#fff}#comment-comment{width:100%;resize:vertical;min-height:8em}.grecaptcha-badge{visibility:hidden}#comment-recaptcha-disclaimer{text-align:justify;text-align-last:center;font-size:.7em}#comment-submit-error{color:red;display:none}.comment-info-text{letter-spacing:.5px;text-align:center}.comment-info-text p{margin:0 0 1rem;text-align:justify;text-align-last:center;font-size:.9em}#comment-container{width:100%}#comment-section,#load-comments{display:flex;flex-direction:column;justify-content:center}#comments-and-input{display:none}</style>{% endif %}